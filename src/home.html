<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Obsidian | Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Fuente -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #fff;
            min-height: 100vh;
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: linear-gradient(135deg, #6c5ce7, #00cec9);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        }

        header h1 {
            font-size: 22px;
            font-weight: 900;
        }

        header button {
            background: rgba(255,255,255,0.2);
            border: 1px solid #fff;
            border-radius: 6px;
            color: #fff;
            padding: 8px 16px;
            cursor: pointer;
        }

        .layout {
            display: flex;
            padding-top: 60px;
        }

        .sidebar {
            width: 220px;
            background: rgba(0,0,0,0.25);
            backdrop-filter: blur(10px);
            padding: 20px;
            position: fixed;
            top: 60px;
            bottom: 0;
            left: 0;
        }

        .sidebar h2 {
            font-size: 16px;
            margin-bottom: 20px;
            color: #ffcc00;
        }

        .sidebar a {
            display: block;
            color: #fff;
            text-decoration: none;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            transition: background 0.3s;
            cursor: pointer;
        }

        .sidebar a:hover,
        .sidebar a.active {
            background: rgba(255,255,255,0.15);
        }

        .content {
            margin-left: 240px;
            padding: 30px;
            width: 100%;
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: rgba(255,255,255,0.12);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 14px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .card h3 {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .card p {
            font-size: 28px;
            font-weight: 900;
            color: #ffcc00;
        }

        .section {
            display: none;
            animation: fade 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fade {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<h1 id="usuario">Cargando...</h1>

<button onclick="cerrarSesion()">Cerrar sesi√≥n</button>

<script>
    function logout() {
        localStorage.clear();
        window.location.href = "index.html";
    }
</script>

<header>
    <h1 id="usuarioNombre">Obsidian</h1>
    <button onclick="cerrarSesion()">Cerrar sesi√≥n</button>
</header>

<div class="layout">

    <aside class="sidebar">
        <h2>Men√∫</h2>
        <a class="active" onclick="mostrarSeccion('inicio', this)">Inicio</a>
        <a onclick="mostrarSeccion('gastos', this)">Gastos</a>
        <a onclick="mostrarSeccion('mensajes', this)">Mensajes</a>
        <a onclick="mostrarSeccion('config', this)">Configuraci√≥n</a>
    </aside>

    <main class="content">

        <section id="inicio" class="section active">
            <h2>Dashboard</h2>
            <p>Resumen general de tu cuenta</p>

            <div class="cards">
                <div class="card">
                    <h3>Gastos del mes</h3>
                    <p>$<span id="dashboardGastos">0</span></p>
                </div>
                <div class="card">
                    <h3>Publicaciones</h3>
                    <p>0</p>
                </div>
                <div class="card">
                    <h3>Mensajes</h3>
                    <p>0</p>
                </div>
                <div class="card">
                    <h3>Estado</h3>
                    <p>Activo</p>
                </div>
            </div>
        </section>

        <!-- GASTOS -->
        <section id="gastos" class="section">
            <h2>Gastos</h2>
            <p>Registra y controla tus gastos üí∞</p>


            <div class="card" style="margin-top:20px;">
                <h3>Nuevo gasto</h3>

                <input id="gastoDescripcion" placeholder="Descripci√≥n"
                       style="width:100%;padding:10px;margin:8px 0;border-radius:6px;border:none;">

                <!-- SELECT DE CATEGOR√çA (AGREGADO) -->
                <select id="gastoCategoria"
                        style="width:100%;padding:10px;margin:8px 0;border-radius:6px;border:none;">
                    <option value="">Seleccione categor√≠a</option>
                    <option value="Alimentaci√≥n">Alimentaci√≥n</option>
                    <option value="Transporte">Transporte</option>
                    <option value="Servicios">Servicios</option>
                    <option value="Entretenimiento">Entretenimiento</option>
                    <option value="Otros">Otros</option>
                </select>
                <input id="gastoFecha" type="date"
                       style="width:100%;padding:10px;margin:8px 0;border-radius:6px;border:none;">

                <input id="gastoMonto" type="number" placeholder="Monto"
                       style="width:100%;padding:10px;margin:8px 0;border-radius:6px;border:none;">

                <button onclick="agregarGasto()"
                        style="margin-top:10px;padding:10px 16px;border:none;border-radius:6px;
      background:#00cec9;color:#000;font-weight:700;cursor:pointer;">
                    Agregar gasto
                </button>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3>Lista de gastos</h3>
                <ul id="listaGastos" style="list-style:none;margin-top:10px;"></ul>
                <h3 style="margin-top:15px;">Total: $<span id="totalGastos">0</span></h3>

            </div>
            <div class="card" style="margin-top:20px;">
                <h3>Filtrar por mes</h3>

                <input type="month" id="filtroMes"
                       style="width:100%;padding:10px;border-radius:6px;border:none;"
                       onchange="aplicarFiltroMes()">
            </div>
            <div class="card" style="margin-top:20px;">
                <h3>Resumen por categor√≠a</h3>
                <ul id="resumenCategorias" style="list-style:none;margin-top:10px;"></ul>
                <div class="card" style="margin-top:20px;">
                    <h3>Gr√°fica de gastos por categor√≠a</h3>
                    <canvas id="graficaCategorias" height="200"></canvas>
                </div>

            </div>

        </section>

        <section id="mensajes" class="section">
            <h2>Mensajes</h2>
            <p>Bandeja de mensajes en construcci√≥n ‚úâÔ∏è</p>
        </section>

        <section id="config" class="section">
            <h2>Configuraci√≥n</h2>
            <p>Ajustes del perfil y preferencias ‚öôÔ∏è</p>
        </section>

    </main>
</div>

<script>
    const token = localStorage.getItem("token");

    if (!token) {
        window.location.href = "index.html";
    }

    const usuario = JSON.parse(localStorage.getItem("usuarioActual"));
    if (!usuario) {
        window.location.href = "index.html";
    } else {
        document.getElementById("usuarioNombre").textContent = usuario.nombre;
    }

    function cerrarSesion() {
        localStorage.removeItem("usuarioActual");
        localStorage.removeItem("token");  // <- BORRAR token JWT
        window.location.href = "index.html";
    }

    function mostrarSeccion(id, link) {
        document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
        document.getElementById(id).classList.add("active");

        document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("active"));
        link.classList.add("active");
    }

    const usuarioKey = "gastos_" + usuario.correo;

    function obtenerGastos() {
        return JSON.parse(localStorage.getItem(usuarioKey)) || [];
    }

    function guardarGastos(gastos) {
        localStorage.setItem(usuarioKey, JSON.stringify(gastos));
    }

    function agregarGasto() {
        const descripcion = document.getElementById("gastoDescripcion").value.trim();
        const categoria = document.getElementById("gastoCategoria").value;
        const fecha = document.getElementById("gastoFecha").value;
        const monto = parseFloat(document.getElementById("gastoMonto").value);

        if (!descripcion || !categoria || !fecha || isNaN(monto) || monto <= 0) {
            alert("Complete todos los campos correctamente");
            return;
        }

        const gastos = obtenerGastos();
        gastos.push({
            id: Date.now(),
            descripcion,
            categoria,
            fecha,
            monto
        });

        guardarGastos(gastos);

        document.getElementById("gastoDescripcion").value = "";
        document.getElementById("gastoCategoria").value = "";
        document.getElementById("gastoFecha").value = "";
        document.getElementById("gastoMonto").value = "";

        renderizarGastos();
    }

    function eliminarGasto(id) {
        let gastos = obtenerGastos();
        gastos = gastos.filter(g => g.id !== id);
        guardarGastos(gastos);
        renderizarGastos();
    }

    function renderizarGastos() {
        const lista = document.getElementById("listaGastos");
        const totalSpan = document.getElementById("totalGastos");
        const gastos = obtenerGastos();

        lista.innerHTML = "";
        let total = 0;

        gastos.forEach(g => {
            total += g.monto;

            const li = document.createElement("li");
            li.style.marginBottom = "8px";
            li.innerHTML = `
                <strong>${g.descripcion}</strong>
<em>(${g.categoria})</em> - $${g.monto}
<br>
<small>üìÖ ${g.fecha}</small>
                <button onclick="eliminarGasto(${g.id})"
                    style="margin-left:10px;background:red;color:white;
                    border:none;border-radius:4px;cursor:pointer;">
                    X
                </button>
            `;
            lista.appendChild(li);
        });

        totalSpan.textContent = total.toLocaleString();
        document.getElementById("dashboardGastos").textContent = total.toLocaleString();
        renderizarResumenCategorias();
        renderizarGraficaCategorias();


    }

    renderizarGastos();
    function renderizarResumenCategorias() {
        const gastos = obtenerGastos();
        const resumen = {};
        const listaResumen = document.getElementById("resumenCategorias");

        // Agrupar gastos por categor√≠a
        gastos.forEach(g => {
            if (!resumen[g.categoria]) {
                resumen[g.categoria] = 0;
            }
            resumen[g.categoria] += g.monto;
        });

        // Limpiar lista
        listaResumen.innerHTML = "";

        // Mostrar resultados
        for (const categoria in resumen) {
            const li = document.createElement("li");
            li.style.marginBottom = "6px";
            li.innerHTML = `
                <strong>${categoria}:</strong> $${resumen[categoria].toLocaleString()}
            `;
            listaResumen.appendChild(li);
        }
    }
    function renderizarGraficaCategorias() {
        const gastos = obtenerGastos();
        const resumen = {};

        // Agrupar montos por categor√≠a
        gastos.forEach(g => {
            if (!resumen[g.categoria]) {
                resumen[g.categoria] = 0;
            }
            resumen[g.categoria] += g.monto;
        });

        const canvas = document.getElementById("graficaCategorias");
        const ctx = canvas.getContext("2d");

        // Limpiar canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const categorias = Object.keys(resumen);
        const valores = Object.values(resumen);

        if (categorias.length === 0) return;

        const maxValor = Math.max(...valores);
        const padding = 40;
        const anchoBarra = (canvas.width - padding * 2) / categorias.length;

        categorias.forEach((cat, index) => {
            const altura =
                (valores[index] / maxValor) * (canvas.height - padding * 2);

            const x = padding + index * anchoBarra;
            const y = canvas.height - padding - altura;

            // Barra
            ctx.fillStyle = "#00cec9";
            ctx.fillRect(x, y, anchoBarra - 10, altura);

            // Texto categor√≠a
            ctx.fillStyle = "#ffffff";
            ctx.font = "12px Roboto";
            ctx.fillText(cat, x, canvas.height - 10);

            // Texto valor
            ctx.fillText(
                `$${valores[index].toLocaleString()}`,
                x,
                y - 5
            );
        });
    }
    function aplicarFiltroMes() {
        const mesSeleccionado = document.getElementById("filtroMes").value;
        const gastos = obtenerGastos();

        if (!mesSeleccionado) {
            renderizarGastos(); // sin filtro
            return;
        }

        const gastosFiltrados = gastos.filter(g => {
            return g.fecha.startsWith(mesSeleccionado);
        });

        renderizarGastosFiltrados(gastosFiltrados);
    }
    function renderizarGastosFiltrados(gastos) {
        const lista = document.getElementById("listaGastos");
        const totalSpan = document.getElementById("totalGastos");

        lista.innerHTML = "";
        let total = 0;

        gastos.forEach(g => {
            total += g.monto;

            const li = document.createElement("li");
            li.style.marginBottom = "8px";
            li.innerHTML = `
            <strong>${g.descripcion}</strong>
            <em>(${g.categoria})</em>
            <small>${g.fecha}</small> - $${g.monto}
        `;
            lista.appendChild(li);
        });

        totalSpan.textContent = total.toLocaleString();
        document.getElementById("dashboardGastos").textContent =
            total.toLocaleString();

        renderizarResumenCategoriasFiltrado(gastos);
        renderizarGraficaCategoriasFiltrado(gastos);
    }
    function renderizarResumenCategoriasFiltrado(gastos) {
        const resumen = {};
        const listaResumen = document.getElementById("resumenCategorias");

        gastos.forEach(g => {
            if (!resumen[g.categoria]) resumen[g.categoria] = 0;
            resumen[g.categoria] += g.monto;
        });

        listaResumen.innerHTML = "";

        for (const categoria in resumen) {
            const li = document.createElement("li");
            li.innerHTML = `<strong>${categoria}:</strong> $${resumen[categoria].toLocaleString()}`;
            listaResumen.appendChild(li);
        }
    }
    function renderizarGraficaCategorias() {
        const gastos = obtenerGastos();
        const resumen = {};

        gastos.forEach(g => {
            if (!resumen[g.categoria]) resumen[g.categoria] = 0;
            resumen[g.categoria] += g.monto;
        });

        const canvas = document.getElementById("graficaCategorias");
        const ctx = canvas.getContext("2d");

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const categorias = Object.keys(resumen);
        const valores = Object.values(resumen);
        if (!categorias.length) return;

        const padding = 20;
        const labelWidth = 140;   // espacio fijo para texto
        const barHeight = 26;
        const gap = 14;
        const maxValor = Math.max(...valores);

        // Ajustar alto del canvas seg√∫n cantidad
        canvas.height = categorias.length * (barHeight + gap) + padding * 2;

        categorias.forEach((cat, i) => {
            const y = padding + i * (barHeight + gap);

            const barWidth =
                (valores[i] / maxValor) *
                (canvas.width - labelWidth - padding * 2);

            /* Texto categor√≠a (izquierda) */
            ctx.fillStyle = "#ffffff";
            ctx.font = "14px Roboto";
            ctx.textAlign = "left";
            ctx.fillText(cat, 10, y + 18);

            /* Barra */
            ctx.fillStyle = "#00cec9";
            ctx.fillRect(labelWidth, y, barWidth, barHeight);

            /* Valor (derecha de la barra) */
            ctx.textAlign = "left";
            ctx.fillText(
                `$${valores[i].toLocaleString()}`,
                labelWidth + barWidth + 8,
                y + 18
            );
        });
    }

</script>
<script>
    const token = localStorage.getItem("token");

    if (!token) {
        // No hay token ‚Üí fuera
        window.location.href = "index.html";
    }

    async function cargarPerfil() {
        try {
            const response = await fetch("http://localhost:3000/perfil", {
                headers: {
                    "Authorization": "Bearer " + token
                }
            });

            const data = await response.json();

            if (!response.ok) {
                alert("Sesi√≥n expirada, vuelve a iniciar sesi√≥n");
                localStorage.clear();
                window.location.href = "index.html";
                return;
            }

            document.getElementById("usuario").textContent =
                "Bienvenido " + data.usuario.nombre;

        } catch (error) {
            console.error(error);
        }
    }

    cargarPerfil();
</script>
</body>
</html>
